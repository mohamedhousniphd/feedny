<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <title>Dashboard - Afeedny</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>

<body>
    <div class="container dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Tableau de bord - {{name}}</h1>
            <div class="header-controls">
                <div class="code-display" title="Partagez ce code avec vos √©tudiants">
                    Code: <strong id="teacher-code-display">{{unique_code}}</strong>
                    <button id="edit-code-btn" class="btn btn-sm"
                        style="padding: 2px 4px; font-size: 0.7em;">‚úèÔ∏è</button>
                </div>
                <div class="credits_display"
                    style="background: #e3f2fd; padding: 5px 10px; border-radius: 4px; margin-right: 10px;">
                    üíé Cr√©dits: <strong id="credits-count">{{credits}}</strong>
                    <a href="/static/payment.html" class="btn btn-sm btn-primary"
                        style="margin-left: 5px; font-size: 0.8em; padding: 2px 8px;">Recharger</a>
                </div>
                <button id="logout-btn" class="btn btn-secondary">D√©connexion</button>
                <a href="/admin" id="admin-panel-link" class="btn btn-secondary hidden"
                    style="background: #333; color: white;">‚öôÔ∏è Admin</a>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-feedbacks">0</div>
                <div class="stat-label">Total Feedbacks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="selected-feedbacks">0</div>
                <div class="stat-label">S√©lectionn√©s</div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions">
            <button id="refresh-btn" class="btn btn-secondary" title="Rafra√Æchir">
                üîÑ Rafra√Æchir
            </button>
            <button id="export-csv-btn" class="btn btn-secondary" title="Exporter CSV">
                üì• CSV
            </button>
            <button id="export-json-btn" class="btn btn-secondary" title="Exporter JSON">
                üíæ Export JSON
            </button>
            <button id="import-json-btn" class="btn btn-secondary" title="Importer JSON">
                üì§ Import JSON
            </button>
            <input type="file" id="import-file-input" class="import-file-input" accept=".json">
            <button id="reset-btn" class="btn btn-danger" title="R√©initialiser">
                üóëÔ∏è R√©initialiser
            </button>
        </div>

        <!-- Question Section -->
        <div class="analysis-section">
            <h2>Question pour les √©tudiants</h2>
            <div class="form-group">
                <input type="text" id="teacher-question-input" placeholder="Ex: Comment s'est pass√© votre cours ?"
                    maxlength="200"
                    style="width: 100%; padding: 12px; border: 2px solid var(--color-border-dark); border-radius: 8px;">
            </div>
            <button id="save-question-btn" class="btn btn-primary">
                üíæ Enregistrer la Question
            </button>
        </div>

        <!-- Feedbacks Table -->
        <div class="feedbacks-section">
            <h2>Feedbacks Re√ßus</h2>
            <div class="table-container">
                <table id="feedbacks-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">
                                <input type="checkbox" id="select-all">
                            </th>
                            <th>Feedback</th>
                            <th>√âmotion</th>
                            <th>Date</th>
                            <th>Inclure</th>
                        </tr>
                    </thead>
                    <tbody id="feedbacks-body">
                        <!-- Feedbacks will be loaded here -->
                    </tbody>
                </table>
                <div id="no-feedbacks" class="no-data hidden">
                    <p>Aucun feedback re√ßu pour le moment</p>
                </div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="analysis-section">
            <h2>Analyse</h2>
            <div class="form-group">
                <label for="context">Contexte (pour aider l'IA)</label>
                <textarea id="context" rows="3"
                    placeholder="Ex: Cours de math√©matiques sur les √©quations diff√©rentielles du 15 janvier 2024..."
                    maxlength="1000"></textarea>
            </div>
            <button id="analyze-btn" class="btn btn-primary">
                üìä Analyser les Feedbacks S√©lectionn√©s
            </button>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section hidden">
            <h2>R√©sultats</h2>
            <div id="wordcloud-container" class="wordcloud-container">
                <img id="wordcloud-image" src="" alt="Nuage de mots">
            </div>
            <div class="summary-container">
                <h3>R√©sum√© IA</h3>
                <div id="summary-text"></div>
            </div>
            <button id="download-wordcloud-btn" class="btn btn-secondary">
                üíæ T√©l√©charger le Nuage de Mots
            </button>
            <button id="download-pdf-btn" class="btn btn-pdf">
                üìÑ T√©l√©charger PDF
            </button>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
            <p>Analyse en cours...</p>
        </div>
    </div>

    <footer>
        <p>Developed and maintained by Mohamed HOUSNI Ph.D.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadFeedbacks();
            loadStats();
            loadQuestion();

            // Event listeners
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadFeedbacks();
                loadStats();
                loadQuestion();
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    await fetch('/api/teacher/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = '/login';
                }
            });

            document.getElementById('save-question-btn').addEventListener('click', saveQuestion);
            document.getElementById('export-csv-btn').addEventListener('click', exportCSV);
            document.getElementById('export-json-btn').addEventListener('click', exportJSON);
            document.getElementById('import-json-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });
            document.getElementById('import-file-input').addEventListener('change', importJSON);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('reset-btn').addEventListener('click', resetDatabase);
            document.getElementById('analyze-btn').addEventListener('click', analyzeFeedbacks);
            document.getElementById('select-all').addEventListener('change', toggleAllCheckboxes);
            document.getElementById('edit-code-btn').addEventListener('click', editUniqueCode);
            document.getElementById('download-wordcloud-btn').addEventListener('click', downloadWordcloud);
            document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);
        });

        async function editUniqueCode() {
            const currentCode = document.getElementById('teacher-code-display').textContent;
            const newCode = prompt("Entrez votre nouveau code d'invitation (min 3 caract√®res) :", currentCode);

            if (!newCode || newCode === currentCode) return;
            if (newCode.length < 3) {
                alert("Le code doit faire au moins 3 caract√®res.");
                return;
            }

            try {
                const response = await fetch('/api/teacher/update_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: newCode })
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('teacher-code-display').textContent = data.new_code;
                    alert("Code mis √† jour avec succ√®s !");
                    location.reload(); // To update any other UI dependencies
                } else {
                    alert(data.detail || "Erreur lors de la mise √† jour du code");
                }
            } catch (error) {
                console.error(error);
                alert("Erreur de connexion");
            }
        }

        let currentWordcloudImage = '';

        async function loadFeedbacks() {
            try {
                const response = await fetch('/api/feedbacks');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();

                const tbody = document.getElementById('feedbacks-body');
                const noFeedbacks = document.getElementById('no-feedbacks');

                if (data.feedbacks.length === 0) {
                    tbody.innerHTML = '';
                    noFeedbacks.classList.remove('hidden');
                    return;
                }

                noFeedbacks.classList.add('hidden');

                tbody.innerHTML = data.feedbacks.map(fb => `
                    <tr data-id="${fb.id}">
                        <td class="checkbox-column">
                            <input type="checkbox" class="feedback-checkbox" value="${fb.id}" ${fb.included_in_analysis ? 'checked' : ''}>
                        </td>
                        <td class="feedback-content">${escapeHtml(fb.content)}</td>
                        <td class="feedback-emotion">${getEmotionEmoji(fb.emotion)}</td>
                        <td class="feedback-date">${formatDate(fb.created_at)}</td>
                        <td class="feedback-status">
                            ${fb.included_in_analysis ? '<span class="status-included">‚úì</span>' : '<span class="status-excluded">‚úó</span>'}
                        </td>
                    </tr>
                `).join('');

                // Add change listeners to checkboxes
                document.querySelectorAll('.feedback-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', async function () {
                        const feedbackId = parseInt(this.value);
                        await toggleFeedback(feedbackId);
                    });
                });

            } catch (error) {
                console.error('Error loading feedbacks:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const stats = await response.json();
                document.getElementById('total-feedbacks').textContent = stats.total;
                document.getElementById('selected-feedbacks').textContent = stats.selected;

                // Show admin link if credits is infinity (admin role)
                const credits = document.getElementById('credits-count').textContent;
                if (credits === '‚àû') {
                    document.getElementById('admin-panel-link').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadQuestion() {
            try {
                const response = await fetch('/api/question');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                document.getElementById('teacher-question-input').value = data.question;
            } catch (error) {
                console.error('Error loading question:', error);
            }
        }

        async function saveQuestion() {
            const question = document.getElementById('teacher-question-input').value.trim();
            if (!question) {
                alert('La question ne peut pas √™tre vide');
                return;
            }

            try {
                const response = await fetch('/api/question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question })
                });

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                if (response.ok) {
                    alert('Question enregistr√©e avec succ√®s');
                } else {
                    alert('Erreur lors de l\'enregistrement');
                }
            } catch (error) {
                console.error('Error saving question:', error);
                alert('Erreur de connexion');
            }
        }

        async function toggleFeedback(feedbackId) {
            try {
                await fetch(`/api/feedbacks/${feedbackId}/toggle`, {
                    method: 'PUT'
                });
                loadFeedbacks();
                loadStats();
            } catch (error) {
                console.error('Error toggling feedback:', error);
            }
        }

        function toggleAllCheckboxes(e) {
            const checkboxes = document.querySelectorAll('.feedback-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        }

        async function analyzeFeedbacks() {
            const selectedIds = Array.from(document.querySelectorAll('.feedback-checkbox:checked'))
                .map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                alert('Veuillez s√©lectionner au moins un feedback');
                return;
            }

            const context = document.getElementById('context').value.trim();
            if (!context) {
                alert('Veuillez fournir un contexte pour l\'analyse');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        feedback_ids: selectedIds,
                        context: context
                    })
                });

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    alert('Erreur: ' + (data.detail || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Error analyzing feedbacks:', error);
                alert('Erreur r√©seau. V√©rifiez votre connexion et r√©essayez.');
            } finally {
                showLoading(false);
            }
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('results-section');
            const wordcloudImage = document.getElementById('wordcloud-image');
            const summaryText = document.getElementById('summary-text');

            if (data.wordcloud_data && data.wordcloud_data.image) {
                currentWordcloudImage = data.wordcloud_data.image;
                wordcloudImage.src = 'data:image/png;base64,' + data.wordcloud_data.image;
            }

            // Store analysis text for PDF export
            currentAnalysisData = data.summary;

            summaryText.innerHTML = formatMarkdown(data.summary);
            resultsSection.classList.remove('hidden');
        }

        function downloadWordcloud() {
            if (!currentWordcloudImage) return;

            const link = document.createElement('a');
            link.href = 'data:image/png;base64,' + currentWordcloudImage;
            link.download = 'feedny_wordcloud.png';
            link.click();
        }

        async function exportCSV() {
            try {
                window.location.href = '/api/export/csv';
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Erreur lors de l\'export CSV');
            }
        }

        async function resetDatabase() {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer tous les feedbacks?')) {
                return;
            }

            if (!confirm('Cette action est irr√©versible. Continuer?')) {
                return;
            }

            try {
                const response = await fetch('/api/reset', {
                    method: 'POST'
                });

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                if (response.ok) {
                    alert('Base de donn√©es r√©initialis√©e avec succ√®s');
                    location.reload();
                } else {
                    alert('Erreur lors de la r√©initialisation');
                }
            } catch (error) {
                console.error('Error resetting database:', error);
                alert('Erreur de connexion. Veuillez r√©essayer.');
            }
        }

        async function logout() {
            try {
                await fetch('/api/teacher/logout', { method: 'POST' });
                window.location.href = '/teacher';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMarkdown(text) {
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        // Emotion emoji mapping
        function getEmotionEmoji(emotion) {
            const emojis = {
                1: 'üò¢', 2: 'üòî', 3: 'üòï', 4: 'üòê', 5: 'üôÇ',
                6: 'üòä', 7: 'üòÉ', 8: 'üòÑ', 9: 'ü§©', 10: 'ü•≥'
            };
            return emotion ? emojis[emotion] || '‚Äî' : '‚Äî';
        }

        // Export JSON
        async function exportJSON() {
            try {
                window.location.href = '/api/export/json';
            } catch (error) {
                console.error('Error exporting JSON:', error);
                alert('Erreur lors de l\'export JSON');
            }
        }

        // Import JSON
        async function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('Importer ce fichier ajoutera les feedbacks √† la base existante. Continuer?')) {
                event.target.value = '';
                return;
            }

            showLoading(true);

            try {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const response = await fetch('/api/import', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: e.target.result
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert(result.message);
                            loadFeedbacks();
                            loadStats();
                        } else {
                            alert('Erreur: ' + (result.detail || 'Erreur inconnue'));
                        }
                    } catch (err) {
                        alert('Erreur lors de l\'import: ' + err.message);
                    }
                    showLoading(false);
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error importing JSON:', error);
                alert('Erreur lors de la lecture du fichier');
                showLoading(false);
            }

            event.target.value = '';
        }

        // Store analysis data for PDF
        let currentAnalysisData = null;

        // Download PDF
        async function downloadPDF() {
            if (!currentWordcloudImage || !currentAnalysisData) {
                alert('Veuillez d\'abord analyser les feedbacks');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/api/export/pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        wordcloud_image: currentWordcloudImage,
                        analysis_text: currentAnalysisData,
                        context: document.getElementById('context').value.trim()
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `feedny_analyse_${new Date().toISOString().slice(0, 10)}.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.json();
                    alert('Erreur: ' + (error.detail || 'Erreur lors de la g√©n√©ration du PDF'));
                }
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Erreur de connexion. Veuillez r√©essayer.');
            }

            showLoading(false);
        }
    </script>
</body>

</html>