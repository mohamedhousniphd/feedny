<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afeedny - Feedback Ã‰tudiant</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Afeedny</h1>
            <p class="subtitle">Partagez votre feedback</p>
            <p style="margin-top: 5px; font-size: 0.8em;"><a href="/api/student/logout"
                    style="color: #666; text-decoration: underline;">Changer de cours</a></p>
        </div>

        <div id="feedback-form" class="feedback-form">
            <div class="question-container">
                <h2 id="teacher-question">{{question}}</h2>
            </div>

            <div class="form-group">
                <label for="feedback-content">Votre feedback</label>
                <textarea id="feedback-content" maxlength="240"
                    placeholder="Partagez vos pensÃ©es... (max 240 caractÃ¨res)" rows="5"></textarea>
                <div class="char-count">
                    <span id="current-chars">0</span>/240
                </div>
            </div>

            <div class="form-group emoji-section">
                <label>Comment vous sentez-vous ?</label>
                <div class="emoji-picker" id="emoji-picker">
                    <button type="button" class="emoji-btn" data-emotion="1" title="TrÃ¨s triste">ğŸ˜¢</button>
                    <button type="button" class="emoji-btn" data-emotion="2" title="Triste">ğŸ˜”</button>
                    <button type="button" class="emoji-btn" data-emotion="3" title="DÃ©Ã§u">ğŸ˜•</button>
                    <button type="button" class="emoji-btn" data-emotion="4" title="Neutre">ğŸ˜</button>
                    <button type="button" class="emoji-btn" data-emotion="5" title="Content">ğŸ™‚</button>
                    <button type="button" class="emoji-btn" data-emotion="6" title="Satisfait">ğŸ˜Š</button>
                    <button type="button" class="emoji-btn" data-emotion="7" title="Heureux">ğŸ˜ƒ</button>
                    <button type="button" class="emoji-btn" data-emotion="8" title="TrÃ¨s heureux">ğŸ˜„</button>
                    <button type="button" class="emoji-btn" data-emotion="9" title="Ravi">ğŸ¤©</button>
                    <button type="button" class="emoji-btn" data-emotion="10" title="Euphorique">ğŸ¥³</button>
                </div>
                <input type="hidden" id="selected-emotion" value="">
            </div>

            <button id="submit-btn" class="btn btn-primary" type="submit">
                Envoyer
            </button>
        </div>

        <div id="success-message" class="success-message hidden">
            <div class="success-icon">âœ“</div>
            <h2>Merci !</h2>
            <p>Votre feedback a Ã©tÃ© enregistrÃ© avec succÃ¨s.</p>
            <p class="info">L'enseignant analysera les feedbacks avant d'ouvrir une nouvelle collecte.</p>
        </div>

        <div id="already-submitted" class="info-message hidden">
            <div class="info-icon">â„¹</div>
            <h2>DÃ©jÃ  envoyÃ©</h2>
            <p>Vous avez dÃ©jÃ  soumis un feedback.</p>
            <p class="info">Veuillez attendre que l'enseignant ouvre une nouvelle collecte.</p>
        </div>
    </div>

    <script>
        // Check if user can submit
        const canSubmit = {{ can_submit }};
        const deviceId = '{{device_id}}';
        console.log('Afeedny script initialized', { canSubmit, deviceId });

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('feedback-form');
            const successMessage = document.getElementById('success-message');
            const alreadySubmitted = document.getElementById('already-submitted');
            const textarea = document.getElementById('feedback-content');
            const submitBtn = document.getElementById('submit-btn');
            const currentChars = document.getElementById('current-chars');
            const emojiPicker = document.getElementById('emoji-picker');
            const selectedEmotionInput = document.getElementById('selected-emotion');

            // Show appropriate message based on submission status
            if (!canSubmit) {
                form.classList.add('hidden');
                alreadySubmitted.classList.remove('hidden');
                return;
            }

            // Emoji picker logic
            emojiPicker.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    // Remove selected class from all buttons
                    emojiPicker.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    // Store the emotion value
                    selectedEmotionInput.value = this.dataset.emotion;
                });
            });

            // Character counter
            textarea.addEventListener('input', function () {
                const length = this.value.length;
                currentChars.textContent = length;

                if (length >= 240) {
                    currentChars.style.color = '#ef4444';
                } else if (length >= 200) {
                    currentChars.style.color = '#f59e0b';
                } else {
                    currentChars.style.color = '#6b7280';
                }
            });

            // Submit feedback
            submitBtn.addEventListener('click', async function (e) {
                e.preventDefault();
                const content = textarea.value.trim();
                const emotion = selectedEmotionInput.value ? parseInt(selectedEmotionInput.value) : null;

                if (!content) {
                    alert('Veuillez entrer votre feedback');
                    return;
                }

                if (content.length > 240) {
                    alert('Votre feedback dÃ©passe la limite de 240 caractÃ¨res');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Envoi en cours...';

                try {
                    const payload = { content: content };
                    if (emotion) {
                        payload.emotion = emotion;
                    }

                    const response = await fetch('/api/feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        form.classList.add('hidden');
                        successMessage.classList.remove('hidden');
                    } else {
                        const error = await response.json();
                        alert(error.detail || 'Erreur lors de l\'envoi');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Envoyer';
                    }
                } catch (error) {
                    alert('Erreur de connexion. Veuillez rÃ©essayer.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Envoyer';
                }
            });
        });
    </script>

    <footer style="margin-top: 40px; color: #666; font-size: 0.9em; text-align: center;">
        <p>Developed and maintained by Mohamed HOUSNI Ph.D.</p>
    </footer>
</body>

</html>